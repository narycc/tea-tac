<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>微信端关联账号管理</title> <!-- TO DO -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!-- PUBLIC STYLES: base.css -->
    <link rel="stylesheet" href="styles/css/base.css">
    <!-- PUBLIC STYLES END -->
    <script type="text/javascript" src="js/vendor/jquery.js"></script>
    <script type="text/javascript" src="js/vendor/bootstrap.js"></script>
    <script type="text/javascript" src="js/vendor/jquery.mobile.custom.min.js"></script>
    <script type="text/javascript" src="js/plugins/underscore.js"></script>
  </head>
  <body>
    <div class="main-page liuxian-page-manageAccounts">
      <div class="container container-liuxian bg-paper-gray">
        
        <div class="b-img">
          <img src="images/header_option_2.jpg" alt="">
        </div>
        
        
        <div class="b-accountsList" id="accounts_list">
          <section class="section">
            <div class="b-state">当前登录账户</div>

            <div class="row flex-center row-data">
              <div class="col-xs-3 col-sm-4 b-img"><img src="images/defaultImage.jpg"></div>
              <div class="col-xs-9 col-sm-6 text-left b-text">
                <div class="s-name">张晓辉 初三（5）班</div>
              </div>
            </div>
          </section>

          <section class="section">
            <div class="b-state">其他关联账户</div>
            <div class="row flex-center row-data">
              <div class="col-xs-3 col-sm-4 b-img"><img src="images/defaultImage.jpg"></div>
              <div class="col-xs-7 col-sm-6 text-left b-text">
                <div class="s-name row">张晓辉 初三（5）班</div>
                <div class="s-operate row">
                  <a href="javascript:void(0);" class="b-remove a-btn-light m-r-lg">解除关联</a>
                </div>
              </div>
              <div class="col-xs-2">
                <a href="javascript:void(0);" class="b-change a-btn-primary">登录</a>
              </div>
            </div>

            <div class="row flex-center row-data">
              <div class="col-xs-3 col-sm-4 b-img"><img src="images/defaultImage.jpg"></div>
              <div class="col-xs-7 col-sm-6 text-left b-text">
                <div class="s-name row">张晓辉 初三（5）班</div>
                <div class="s-operate row">
                  <a href="javascript:void(0);" class="b-remove a-btn-light m-r-lg">解除关联</a>
                </div>
              </div>
              <div class="col-xs-2">
                <a href="javascript:void(0);" class="b-change a-btn-primary">登录</a>
              </div>
            </div>

            <div class="row flex-center row-data">
              <div class="col-xs-3 col-sm-4 b-img"><img src="images/defaultImage.jpg"></div>
              <div class="col-xs-7 col-sm-6 text-left b-text">
                <div class="s-name row">张晓辉 初三（5）班</div>
                <div class="s-operate row">
                  <a href="javascript:void(0);" class="b-remove a-btn-light m-r-lg">解除关联</a>
                </div>
              </div>
              <div class="col-xs-2">
                <a href="javascript:void(0);" class="b-change a-btn-primary">登录</a>
              </div>
            </div>
          </section>
        </div>

        <div class="btn btn-primary">
          <a class="btn-add-binding" href="javascript:void(0);">添加账号绑定</a>
        </div>
      </div>
    </div>
  </body>
</html>
<script src="js/api.js"></script>
<script>
  var userinfo = {};
  var cur_checked_class = 0;
  var cur_checked_team = 0;
  var checked_sids = [];

  function init(){
    $('#check_all_btn').on('click',function(){
      checkStudentAll();
    });
    $('#next_step').on('click',function(){
      //alert(JSON.stringify({member_id:checked_sids}));
      jump('uploadProject', 'workRelease', {member_id:checked_sids})
    });
    if(api.pageParam.user){
      userinfo =api.pageParam.user;
      initPage(userinfo);
    }else{
      userinfo = $api.getStorage('uinfo');
      if(!userinfo || !userinfo.id){
        jump('login', 'teacher');
        return false;
      }else{
        initPage(userinfo);
      }
    }
    $('#search_key').on('blur',function(){
      getStudentLists();
    });
  }

  function initPageTitle(){
    var title = '我的学生';

    api.sendEvent({
        name: 'changePage',
        extra: {
          pageTo: 'index', 
          pageFrom: 'main',
          pageTitle: title,
        }
    });
  }

  function initTeachClass(userinfo){
    if(userinfo.teach_class){
      var  teach_class = userinfo.teach_class;
      var html = '';
      var i = 0;
      for(var k in teach_class){
        if(i==0){
          cur_checked_class = teach_class[k].class;
          checked_cs = 'class="checked"';
          $('.b-cur-class').text(parseInt(cur_checked_class/100)+'年级'+parseInt(cur_checked_class%100)+'班');
        }else{
          checked_cs = '';
        }
        html += '<li cid="'+teach_class[k].class+'" '+checked_cs+'>'+parseInt(teach_class[k].class/100)+'年级'+parseInt(teach_class[k].class%100)+'班</li>';
        i++;
      }
      $('#teach_class').html(html);
      $('#teach_class li').on('click',function(){
        changeClassVal(this);
      });
    }

    if(userinfo.teams){
      var teams = userinfo.teams;
      var len = teams.length;
      var tmp_html = '';
      for(var i=0; i<len; i++){
        tmp_html += '<li cid="'+teams[i]['id']+'">'+teams[i]['title']+'</li>';
      }
      $('#user_teams').html(tmp_html);
      $('#user_teams li').on('click',function(){
        changeTeamVal(this);
      });
    }

    getStudentLists();
  }

  function changeClassVal(obj){
    var id_str = $(obj).attr('cid');
    cur_checked_class = id_str;

    $('#user_teams li').each(function(){
      $(this).removeClass('checked');
    });

    cur_checked_team = 0;

    $('#teach_class li').each(function(){
      if($(this).attr('cid') == id_str){
        $(this).addClass('checked');
      }else{
        $(this).removeClass('checked');
      }
    });

    $('.b-cur-class').text(parseInt(id_str/100)+'年级'+parseInt(id_str%100)+'班');

    getStudentLists();
  }

  function changeTeamVal(obj){
    var id_str = $(obj).attr('cid');
    cur_checked_team = id_str;

    $('#teach_class li').each(function(){
      $(this).removeClass('checked');
    });

    cur_checked_class = 0;

    $('#user_teams li').each(function(){
      if($(this).attr('cid') == id_str){
        $(this).addClass('checked');
      }else{
        $(this).removeClass('checked');
      }
    });

    $('.b-cur-class').text($(obj).html());

    getStudentLists();
  }

  function initPage(userinfo){
    initPageTitle();
    initFocusEvent();
    initTeachClass(userinfo);
  }

  function getStudentLists(){
    var uid = userinfo.id;
    name = $('#search_key').val();
    //alert(JSON.stringify({search:1, name:name, class_id:cur_checked_class, 'team_id':cur_checked_team}));
    ajaxRequest('User/getUser', 'GET', {search:1, name:name, class_id:cur_checked_class, 'team_id':cur_checked_team}, function(ret,err){
      if(ret.code == 0 && ret.data && ret.data.list && ret.data.list.length>0){
        var list = ret.data.list;
        var len = list.length;
        var html = '';
        for(var i=0; i<len; i++){
          item = list[i];
          html += '<div class="row "><a href="javascript://" onclick="jump(\'main\', \'teacher\', {uid:'+item.id+'})" class="flex-center"><div class="col-xs-3 col-sm-4 b-img"><img src="'+(item.avatar?item.avatar:'images/defaultImage.jpg')+'"></div><div class="col-xs-7 col-sm-6 text-left b-text"><div class="s-name">'+item.name+'</div><div class="s-project">'+item.grade+'年级'+item.class+'班</div></div><div class="col-xs-2 text-right"><span class="goto glyphicon glyphicon-menu-right"></span></div></a></div>';
        }
        $('#student_list').html(html);
      }else{
        $('#student_list').html('<div class="row"><div class="col-xs-12" style="text-align:center;"><h3>没搜索到相关学生</h3></div></div>');
      }
    });
  }

  function initFocusEvent(){
    api.addEventListener({
        name: 'switchFrame'
    }, function( ret, err ){
        //重获焦点
        var data = ret.value;
        if(data.page == 'viewStudent'){
            init();
        }
    });
  }

  apiready = function(){
    init();
    //listenExitApp();
  };
</script>